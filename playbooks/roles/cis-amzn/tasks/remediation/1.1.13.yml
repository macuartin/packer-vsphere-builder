---

# This file also covers:
# 1.1.13 - Ensure separate partition exists for /home
# 1.1.14 - Ensure nodev option set on /home partition

- name: Set check facts
  set_fact:
    cis_code: &cis_code '1.1.13'
    cis_name: &cis_name Ensure separate partition exists for /home
    cis_profile: &cis_profile level-2
    cis_scored: &cis_scored scored
    cis_section: &cis_section section-1
  tags:
    - always

- name: "CIS {{ cis_code }} - {{ cis_name }}"
  block:

  - name: "APPLY | {{ cis_code }} - create /home partition"
    parted:
      device: "{{ sdh }}"
      number: 1
      state: present
    tags:
      - apply

  - name: "APPLY | {{ cis_code }} - create ext4 filesystem on {{ sdh }}{{ part }} and check disk blocks"
    filesystem:
      fstype: ext4
      dev: "{{ sdh }}{{ part }}"
      #opts: -cc -O ^has_journal
      force: yes
    tags:
      - apply

  - name: "APPLY | {{ cis_code }} - require check"
    shell: |
      e2fsck -p -f {{ sdh }}{{ part }}
    tags:
      - apply

  - name: "APPLY | {{ cis_code }} - set label"
    shell: |
      e2label {{ sdh }}{{ part }} /home
    tags:
      - apply

  - name: "APPLY | {{ cis_code }} - dump filesystem options"
    shell: |
      dumpe2fs {{ sdh }}{{ part }}
    register: cis_apply_tmp
    tags:
      - apply
      - debug

  #- name: "APPLY | {{ cis_code }} - print filesystem options"
  #  debug:
  #    var: cis_apply_tmp
  #  tags:
  #    - apply
  #    - debug

  - name: "APPLY | {{ cis_code }} - create mount point, assign permissions"
    file:
      path: /mnt/home
      state: directory
      owner: root
      group: root
      mode: u=rw,g=rx,o=rx
    tags:
      - apply

  - name: "APPLY | {{ cis_code }} - new filesystem mounted"
    mount:
      path: /mnt/home
      src: LABEL=/home
      state: mounted
      fstype: ext4
    tags:
      - apply

  - name: "APPLY | {{ cis_code }} - fix permissions on a new filesystem"
    file:
      path: /mnt/home
      state: directory
      owner: root
      group: root
      mode: u=rw,g=rx,o=rx
    tags:
      - apply

  - name: "APPLY | {{ cis_code }} - copy data to a new location"
    shell: |
      rsync --archive --xattrs --archive --hard-links --partial --one-file-system --progress /home/* /mnt/home
    tags:
      - apply

  - name: "APPLY | {{ cis_code }} - new filesystem unmounted"
    mount:
      path: /mnt/home
      state: unmounted
    tags:
      - apply

  - name: "APPLY | {{ cis_code }} - temporary mount point deleted"
    mount:
      path: /mnt/home
      state: absent
    tags:
      - apply

  - name: "APPLY | {{ cis_code }} - configure a separate mount point"
    mount:
      path: /home
      src: LABEL=/home
      fstype: ext4
      opts: defaults,noatime,nodev
      dump: 1
      passno: 1
      state: present
    tags:
      - apply

  - import_tasks: ../commons/reboot-machine.yml
    vars:
      cis_code: *cis_code

  - name: "APPLY | {{ cis_code }} - clean bind mount"
    shell: |
      mkdir -p /mnt/root
      mount --bind / /mnt/root
      rm -rf /mnt/root/home/*
      umount /mnt/root
      rmdir /mnt/root
    tags:
      - apply

  # TODO: Detailed fact
  - name: "APPLY | {{ cis_code }} - set apply fact."
    set_fact: {"cis_{{ cis_code | regex_replace('[.]','_') }}_apply":"{{ cis_apply_tmp }}"}
    tags:
      - apply

  # TODO: Post checks

  tags:
    - *cis_profile
    - *cis_section
    - *cis_code
    - *cis_scored

...
